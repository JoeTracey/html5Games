<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Dog Shooter</title>
    <script src = "phaser.js"></script>
    <style type="text/css">
        body = {
            margin: 0;
        }
    </style>
</head>

<body>
<script type="text/javascript">

var config = {
    type:Phaser.Auto,
    width: 500,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            // gravity: {y:50},
            debug:false
        }
    },
    scene: {
        preload:preload,
        create: create,
        update: update,
    }
};

var game = new Phaser.Game(config);
var cursors;
var spawnRate = 0; // set back to 0
var spawnDelay = 100.0;
var spawnCount = 0;
var spawnTimer = 0;
var catSpeed = 100;
var score = 0;
var bossTick = 0; //set back to 0 

var bossScene = false;

var playerEnergy = 0
var playerEnergyText;

var gameOver = false;
var gameOverText;

var spawnRateText;
var spawnTimerText;
var scoreText;

var background;  //
var player;  //
var cats; //
var walls; //
var barks;
var enemyBarks;
var bosses;
var bullets; // bullets shot, shift hue to indicate enemy? use different sprite eventually
            // dog should bark sound waves, maybe a charged larger sound wave
            //      should be slow and powerful
            // Cats should mostly be melee, especially to start
            // Mailman shoots mail
            //  skinny mailman shooting mail straight forward
            //  fat mailman shooting in direction of player
// Later on
// Xp, health, damage, attack speed, power ups/ learned abilities, bosses or additional levels
    //puppies followin as autoturrets, player looks more badass as XP is gained (if xp stays between plays)
var balls;
var kibbles;
var bones;
var beefs;

var playerHealth = 0;
var healthTokens;
var attackType = 'basic';
var playerPowerCharge=0;


function preload(){
    this.load.spritesheet('background', 'assets/temp/backgroundFrames.png', {frameWidth: 500, frameHeight: 600})
    // this.load.image('player', 'assets/temp/dog.png')
    this.load.spritesheet('player', 'assets/temp/dogFrames.png', {frameWidth: 32, frameHeight: 60});

    this.load.image('cat', 'assets/temp/cat.png')
    this.load.image('bark', 'assets/temp/bark.png')
    this.load.image('boss', 'assets/temp/boss1.png')
    this.load.image('ball', 'assets/temp/tennisBall.png')
    this.load.image('kibble', 'assets/temp/kibble.png')
    this.load.image('bone', 'assets/temp/bone.png')
    this.load.image('beef', 'assets/temp/beef.png')
    this.load.image('hairBall', 'assets/temp/hairBall.png')

}

function create(){
    background = this.add.sprite(250, 300, 'background')
    this.anims.create({
        key: 'scrolling',
        frames: this.anims.generateFrameNumbers('background', { start: 0, end: 2}),
        frameRate: 5,
        repeat: -1
    });
    background.anims.play('scrolling', true)
    //create player as animation
    player = this.physics.add.sprite(250, 500,'player') //use sprite not image when animating
    player.setCollideWorldBounds(true);
    this.anims.create({
        key: 'running',
        frames: this.anims.generateFrameNumbers('player', { start: 0, end: 4}),
        frameRate: 10,
        repeat: -1
    });
    console.log(player)
    console.log(player.anims)
    player.anims.play('running', true);
    //create keyboard input
    cursors = this.input.keyboard.createCursorKeys();
    // create cat
    cats = this.physics.add.group();
    this.physics.add.collider(player, cats, playerHitCat, null, this);
    // create overlay texts
    // spawnRateText = this.add.text(16,16, 'spawnDelay: '+spawnDelay, {fontSize: '32px', fill: '#000'});
    // spawnTimerText = this.add.text(16,48, 'spawnTimer: '+spawnTimer, {fontSize: '32px', fill: '#000'});
    scoreText = this.add.text(16,16, 'score: '+score, {fontSize: '32px', fill: '#000'});
    playerEnergyText = this.add.text(16,500, 'Energy: '+playerEnergy, {fontSize: '32px', fill: '#000'});
    // create bark attack
    barks = this.physics.add.group();
    this.physics.add.collider(barks, cats, attackHitCat, null, this);
    enemyBarks = this.physics.add.group();
    this.physics.add.collider(player, enemyBarks, playerHitCat, null, this);
    //create boss
    bosses = this.physics.add.group();
    this.physics.add.collider(barks, bosses, attackHitBoss, null, this);

    //create power ups
    balls = this.physics.add.group();
    this.physics.add.collider(player, balls, collectBall, null, this);
    kibbles = this.physics.add.group();
    this.physics.add.collider(player, kibbles, collectKibble, null, this);
    bones = this.physics.add.group();
    this.physics.add.collider(player, bones, collectBone, null, this);
    beefs = this.physics.add.group();
    this.physics.add.collider(player, beefs, collectBeef, null, this);

    // healthText = this.add.text(16, 550, 'Health: '+ playerHealth, {fontSize: '32px', fill: '#000'});
    healthTokens = this.physics.add.staticGroup();
    // create 7 tokens, hidden
    healthTokens.create(16, 590, 'beef').visible = false
    healthTokens.create(48, 590, 'beef').visible = false
    healthTokens.create(80, 590, 'beef').visible = false
    healthTokens.create(112, 590, 'beef').visible = false
    healthTokens.create(144, 590, 'beef').visible = false
    healthTokens.create(176, 590, 'beef').visible = false
    healthTokens.create(208, 590, 'beef').visible = false
    increaseHealth();
    increaseHealth();
    increaseHealth();

}

function update(){
    if (cursors.left.isDown){
        player.setVelocityX(-150);
    }
    else if (cursors.right.isDown){
        player.setVelocityX(150);
    }
    else{
        player.setVelocityX(0);
    }
    if (cursors.down.isDown){
        player.setVelocityY(80);
    }
    else if (cursors.up.isDown){
        player.setVelocityY(-80);
    }
    else{
        player.setVelocityY(0);
    }

    if (cursors.space.isDown){
        simpleAttack(player);
    }
    else{
        releaseAttack();
    }
    //update Player energy
    if (playerEnergy < 1000){
    playerEnergy+=1;
    playerEnergyText.setText('Energy: '+ playerEnergy);}



    //Spawn if enough time has passed
    if (spawnTimer >= spawnDelay-spawnRate & !gameOver & !bossScene){
        spawnCat();
        spawnTimer = 0;
        //increase spawn rate
        if (spawnRate < spawnDelay-10){
            spawnRate+=(2*((spawnDelay-spawnRate)/spawnDelay));
        }
        else{
        bossTick +=1;
        }
        // spawnRateText.setText('spawnRate: '+spawnRate);
        // spawnTimerText.setText('spawnTimer: '+spawnTimer);

    }
    if (bossTick === 100 & ! bossScene){
        spawnBoss();
        bossScene = true;
    }
    else {
        spawnTimer +=(1);
        // spawnTimerText.setText('spawnTimer: '+spawnTimer);
    }
    if (bossScene){
        bosses.children.iterate(function(boss){
        if (boss.x >  400){
            // boss.setVelocityX (-50);
            boss.direction = false;
        }
        else if (boss.x <  100){
            // boss.setVelocityX (50);
            boss.direction = true;
        }
        boss.setVelocityY(0);

        if(Phaser.Math.Between(0,30) <1 & !gameOver){bossAttack(boss);}
        if (boss.direction){
            boss.x+=1;
        }
        else {
            boss.x-=1;
        }
    });
    }
    
}

function spawnCat(){
    var x = Phaser.Math.Between(0, 500);
    var cat = cats.create(x,0, 'cat');
    cat.setVelocityY(catSpeed);
}

function playerHitCat(player, cat){
    cat.disableBody(true, true);
    decreaseHealth();
}

function attackHitCat(attack, cat){
    cat.disableBody(true, true);
    attack.disableBody(true, true);
    score+=10;
    scoreText.setText('Score: '+score);
    var x = Phaser.Math.Between(0,16);
    if (x ==0){
        spawnBall(cat);
    }
    if (x ==1){
        spawnKibble(cat);
    }
    if (x ==2){
        spawnBone(cat);
    }
    if (x ==3){
        spawnBeef(cat);
    }
}

function attackHitBoss(attack, boss){
    // boss.disableBody(true, true);
    attack.disableBody(true, true);
    score+=10;
    scoreText.setText('Score: '+score);
    console.log('hit bosss')
    if (boss.health < 1){
    boss.disableBody(true, true);
    gameOverText = this.add.text(50,300, 'You Win!!!!', {fontSize: '64px', fill: 0xff0000});
    gameOver = true;
    }
    else{
        boss.health -=1;
    }
}

function simpleAttack (player){
    //find player location and shoot out a bark
    var x = player.x;
    var y = player.y;
    if (playerPowerCharge === 0){
        attackType = 'basic';
    }
    if (attackReleased & playerEnergy > 100 & attackType === 'basic'){
    var bark = barks.create(x,y,'bark');
    bark.setVelocityY(-200);
    playerEnergy-= 100;
    console.log('attacked - basic');
    }
    else if (attackReleased & attackType === 'wide'){
        playerPowerCharge -=1;
        var bark = barks.create(x,y,'bark');
        bark.setVelocityY(-200);
        var bark = barks.create(x+8,y,'bark');
        bark.setVelocityY(-200);
        var bark = barks.create(x-8,y,'bark');
        bark.setVelocityY(-200);
        console.log('attacked - wide');
    }
    else if (attackReleased & attackType === 'multi'){
        playerPowerCharge -=1;
        var bark = barks.create(x,y,'bark');
        bark.setVelocityY(-200);
        var bark = barks.create(x+8,y,'bark');
        bark.setVelocityY(-200);
        bark.setVelocityX(-200);
        var bark = barks.create(x-8,y,'bark');
        bark.setVelocityY(-200);
        bark.setVelocityX(200);
        console.log('attacked - wide');
    }
    attackReleased = false;
}


function bossAttack (boss){
    //find player location and shoot out a bark
    if (attackReleased & playerEnergy > 100){
    var x = boss.x;
    var y = boss.y;
    var bark = enemyBarks.create(x,y,'hairBall');
    bark.setVelocityY(200);
    }
}

function releaseAttack(){
attackReleased = true;
}

function spawnBoss(){
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    spawnCat();
    var x = Phaser.Math.Between(0, 500);
    var boss = bosses.create(250,80, 'boss');
    boss.health = 10;
    // boss.setVelocityX(50);
    boss.direction = true;


}



function spawnBall(body){
    var x=body.x;
    var y = body.y;
    var ball = balls.create(x,y, 'ball');
    ball.setVelocityY(catSpeed);
}
function collectBall(player, ball){
    ball.disableBody(true, true);
    attackType = 'wide';
    playerPowerCharge = 10;
}

function spawnKibble(body){
    var x=body.x;
    var y = body.y;
    var kibble = kibbles.create(x,y, 'kibble');
    kibble.setVelocityY(catSpeed);
}
function collectKibble(player, kibble){
    kibble.disableBody(true, true);
    // attackType = 'wide';
    // playerPowerCharge = 10;
    score+=50;
    scoreText.setText('Score: '+score);
}

function spawnBone(body){
    var x=body.x;
    var y = body.y;
    var bone = bones.create(x,y, 'bone');
    bone.setVelocityY(catSpeed);
}
function collectBone(player, bone){
    bone.disableBody(true, true);
    attackType = 'multi';
    playerPowerCharge = 10;
}

function spawnBeef(body){
    var x=body.x;
    var y = body.y;
    var beef = beefs.create(x,y, 'beef');
    beef.setVelocityY(catSpeed);
}
function collectBeef(player, ball){
    ball.disableBody(true, true);
    increaseHealth();
}

function increaseHealth(){
    if (playerHealth < 7){
    playerHealth +=1;
    console.log(playerHealth);
    console.log(healthTokens.children);
    console.log(healthTokens.children.entries);
    console.log(healthTokens.children.entries[playerHealth]);
    token = healthTokens.children.entries[playerHealth-1];
    // token.y = 570; 
    token.visible = true
    // healthTokens.children.get(playerHealth).enableBody(true, playerHealth*16, 570, true, true);
}
}
function decreaseHealth(){
    // healthTokens.children.get(playerHealth).disableBody(true, true);

    token = healthTokens.children.entries[playerHealth-1];
    token.visible = false
    playerHealth -=1;
    if (playerHealth === 0 ){
        gameIsOver();
    } }


function gameIsOver(){
    // player.setTint(0xffffff);
    // this.physics.pause();
    gameOver = true;
    gameOverText = this.add.text(50,300, 'Game Over', {fontSize: '64px', fill: 0xff0000});
    playerHealth +=1;
    healthText.setText('Health: '+ 0);
}
    



</script>    
</body>
</html>